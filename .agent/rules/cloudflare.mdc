---
description: Cloudflare rules. Enforces wrangler.jsonc, local schema validation, and Bun deployment.
globs: wrangler.jsonc, wrangler.toml, open-next.config.ts, src/**/*.ts
alwaysApply: false
---
# Cloudflare Deployment & Runtime Rules

**Trigger:** When editing Cloudflare config, OpenNext config, or discussing deployment.

## 1. Configuration Standards (Strict)
*   **Format:** **ALWAYS** use `wrangler.jsonc` (JSON with Comments). Do NOT use `wrangler.toml` for new configurations.
*   **Schema Validation:** Every `wrangler.jsonc` file **MUST** start with the local schema link to ensure type safety and prevent hallucinated fields:
    ```jsonc
    "$schema": "node_modules/wrangler/config-schema.json",
    ```
*   **Compatibility:** Set `compatibility_date` to a recent date (e.g., "2024-09-23").

## 2. Runtime Constraints (The "Edge" Rule)
*   **Environment:** Enforce `export const runtime = 'edge';` for all route handlers.
*   **Forbidden APIs:** Flag Node.js-only APIs (`fs`, `child_process`). Suggest Web Standard alternatives (`fetch`, `Request`).
*   **Bundle Size:** Target <3MB gzipped. Move heavy libs to Client Components.

## 3. Storage & Caching
*   **Static Assets:** `Cache-Control: public, max-age=3600` minimum.
*   **OpenNext:** If `open-next.config.ts` exists, ensure Incremental Cache is enabled.
*   **R2:** Suggest R2 Buckets over external S3 for better integration/cost.

## 4. Observability (Conditional)
*   **Sentry Check:** Inspect `package.json`.
    *   **If `@sentry/cloudflare` exists:** Implement standard Sentry logging.
    *   **If MISSING:** Do NOT suggest Sentry. Use structured `console.log` (JSON format) to avoid bundle overhead.

## 5. Deployment Protocol (Bun Powered)
*   **Command:** `bunx wrangler deploy`.
*   **Environment:** Use `bunx` for all wrangler commands to match the project runtime.
*   **Checklist:**
    1.  `bun install` (Verify dependency tree).
    2.  `bun run build` (Verify file sizes).
    3.  `bunx wrangler deploy` (Verify schema matches output).

## Example `wrangler.jsonc`
```jsonc
{
  "$schema": "node_modules/wrangler/config-schema.json",
  "name": "my-worker",
  "main": "src/index.ts",
  "compatibility_date": "2024-09-23",
  "compatibility_flags": ["nodejs_compat"],
  "observability": {
    "enabled": true
  },
  "assets": {
    "directory": "./public",
    "binding": "ASSETS"
  },
  // Only include Sentry vars if package is installed
  "vars": {
    "ENVIRONMENT": "production"
  }
}