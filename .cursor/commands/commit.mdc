---
description: Custom Command /commit. Auto-formats (Biome), fixes errors, commits, pushes, and manages Draft PRs.
globs: 
alwaysApply: false
---
# Smart Commit & PR Workflow

**Trigger:** When the user types `/commit [message] [flags]`.

## 1. Context & Setup
1.  **Parse Input:**
    *   **Message:** Text after `/commit`. Default: `"WIP: Biome-clean commit"`.
    *   **Flags:** `--no-pr`, `--dry`, `--no-biome`, `--amend`.
2.  **Detect Repository:**
    *   Run: `git remote get-url origin` -> Extract `OWNER` and `REPO`.
3.  **Detect Branch:**
    *   Run: `git branch --show-current` -> `CURRENT_BRANCH`.

## 2. Phase A: The Biome Gauntlet (Gatekeeper)
**Goal:** Ensure code is clean BEFORE committing.

1.  **Auto-Fix:** Run `bunx @biomejs/biome check --write .`
    *   *Action:* This fixes formatting and safe lint issues automatically.
    *   *Stage:* Run `git add -A` immediately after to stage these fixes.

2.  **Verification (The Gate):** Run `bunx @biomejs/biome ci . --max-diagnostics none`
    *   **IF PASS:** Proceed to Phase B.
    *   **IF FAIL:** Enter **Emergency Fix Mode**.

### ðŸ›‘ Emergency Fix Mode (If CI Fails)
1.  **Analyze:** Read the error log from the failed `ci` command.
2.  **Attempt Fix:** You must manually edit the files to resolve the specific errors (e.g., delete unused variables, fix types) that `--write` could not handle.
3.  **Verify Again:** Run `bunx @biomejs/biome ci . --max-diagnostics none` again.
4.  **Decision:**
    *   **Pass:** Proceed to Phase B.
    *   **Fail:** **ABORT COMMAND.** Output: "âŒ Biome Check Failed. Fix errors manually before committing." **DO NOT COMMIT. DO NOT PR.**

## 3. Phase B: Git Operations (Only if Phase A Passed)
1.  **Stage Final:** `git add -A` (Ensure manual fixes are staged).
2.  **Commit:**
    *   Normal: `git commit -m "MSG"`
    *   Amend: `git commit --amend --no-edit`
3.  **Push:**
    *   `git push origin HEAD` (or `--set-upstream`).

## 4. Phase C: GitHub MCP (Only if Phase A Passed & `--no-pr` is missing)
1.  **Check Existing:** Use `github_list_pull_requests` to check for open PRs on `CURRENT_BRANCH`.
    *   *If Found:* Log "âœ… PR exists." -> Stop.
2.  **Create Draft:**
    *   Use `github_create_pull_request`.
    *   **Base:** `main`.
    *   **Draft:** `true`.
    *   **Body:** "Automated PR.\n- Biome: Passed âœ…"

## 5. Summary Output
**Success:**
> ## ðŸš€ Smart Commit
> *   **Status:** âœ… Success
> *   **Biome:** âœ… Auto-fixed & Verified
> *   **PR:** [Link]

**Failure (Abort):**
> ## âŒ Commit Aborted
> Biome CI failed. I attempted to fix it but errors persist.
> *   **Action:** Please check `bunx @biomejs/biome ci .` output.